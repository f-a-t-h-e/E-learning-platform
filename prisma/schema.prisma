// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  userId    Int          @id @default(autoincrement())
  email     String       @unique
  password  String
  role      Role         @relation(fields: [roleName], references: [name])
  roleName  String
  profile   UserProfile?
  Sessions  Session[]
  // timestamp
  createdAt DateTime     @default(now()) @db.Timestamptz(3)
  updatedAt DateTime     @updatedAt @db.Timestamptz(3)
}

model Session {
  sessionId    Int      @id @default(autoincrement())
  refreshToken String
  userId       Int
  User         User     @relation(fields: [userId], references: [userId])
  createdAt    DateTime @default(now()) @db.Timestamptz(3)
  expiresAt    DateTime @db.Timestamptz(3)
}

model UserProfile {
  userId             Int                 @unique
  user               User                @relation(fields: [userId], references: [userId])
  username           String              @unique
  firstName          String
  secondName         String?
  thirdName          String?
  lastName           String
  bio                String?
  avatar             String?
  banner             String?
  phone              String?
  // timestamp
  createdAt          DateTime            @default(now()) @db.Timestamptz(3)
  updatedAt          DateTime            @updatedAt @db.Timestamptz(3)
  // Relations
  UploadedMedia      CourseMedia[]
  // ChatParticipations ChatParticipant[]
  // CreatedForums      Forum[]
  // ForumMemberIn      ForumMember[]
  // ForumPosts         ForumPost[]
  // ForumComments      ForumComment[]
  Attendance         CourseAttendance[]
  // For instructores
  CreatedUnits       Unit[]
  CreatedLessons     Lesson[]
  InstructoreCourses CourseInstructor[]
  // For students
  LessonsFeedbacks   LessonFeedback[]
  CoursesProgress    CourseProgress[]
  Certificates       CourseCertificate[]
  QuizSubmissions    QuizSubmission[]
  CoursesEnrollment  CourseEnrollment[]
}

model Role {
  name  String @unique
  users User[]
}

model Course {
  courseId         Int                 @id @default(autoincrement())
  title            String
  description      String?
  banner           String?
  // timestamp
  createdAt        DateTime            @default(now()) @db.Timestamptz(3)
  updatedAt        DateTime            @updatedAt @db.Timestamptz(3)
  // Relations
  Units            Unit[]
  Lessons          Lesson[]
  Media            CourseMedia[]
  Students         CourseEnrollment[]
  Instructors      CourseInstructor[]
  Attendance       CourseAttendance[]
  StudentsProgress CourseProgress[]
  Quizzes          Quiz[]
  Certificates     CourseCertificate[]
  Feedbacks        LessonFeedback[]
  // Forums           Forum[]
  QuizSubmissions  QuizSubmission[]
}

model CourseEnrollment {
  courseId  Int
  Course    Course                @relation(fields: [courseId], references: [courseId])
  studentId Int
  Student   UserProfile           @relation(fields: [studentId], references: [userId])
  state     CourseEnrollmentState
  // timestamp
  createdAt DateTime              @default(now()) @db.Timestamptz(3)
  updatedAt DateTime              @updatedAt @db.Timestamptz(3)

  @@id([courseId, studentId])
}

enum CourseEnrollmentState {
  ACTIVE
}

model CourseInstructor {
  courseId     Int
  Course       Course                    @relation(fields: [courseId], references: [courseId])
  instructorId Int
  Instructor   UserProfile               @relation(fields: [instructorId], references: [userId])
  position     CourseInstructorPositions
  state        CourseInstructorState

  @@id([courseId, instructorId])
}

enum CourseInstructorPositions {
  OWNER
  TEACHER
}

enum CourseInstructorState {
  ACTIVE
}

model CourseMedia {
  courseMediaId Int               @id @default(autoincrement())
  url           String
  type          MediaType
  extension     String
  state         MediaState
  bytes         BigInt
  userId        Int
  UserProfile   UserProfile       @relation(fields: [userId], references: [userId])
  courseId      Int?
  Course        Course?           @relation(fields: [courseId], references: [courseId])
  unitId        Int?
  Unit          Unit?             @relation(fields: [unitId], references: [unitId])
  lessonId      Int?
  Lesson        Lesson?           @relation(fields: [lessonId], references: [lessonId])
  target        CourseMediaTarget
  // timestamp
  createdAt     DateTime          @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime          @updatedAt @db.Timestamptz(3)
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
}

enum MediaState {
  UPLOADING
  FAILED
  UPLOADED
}

enum CourseMediaTarget {
  // // 'profile-picture'
  // PROFILE_PICTURE
  // // 'profile-banner'
  // PROFILE_BANNER
  // 'course-banner'
  COURSE_BANNER
  // 'course-material'
  COURSE_MATERIAL
  // 'unit-banner'
  UNIT_BANNER
  // 'unit-material'
  UNIT_MATERIAL
  // 'lesson-banner'
  LESSON_BANNER
  // 'lesson-material'
  LESSON_MATERIAL
}

model Unit {
  unitId      Int           @id @default(autoincrement())
  title       String
  description String?
  banner      String?
  courseId    Int
  // Owner
  addedBy     Int
  AddedBy     UserProfile   @relation(fields: [addedBy], references: [userId])
  Course      Course        @relation(fields: [courseId], references: [courseId])
  // timestamp
  createdAt   DateTime      @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime      @updatedAt @db.Timestamptz(3)
  // Relations
  Lessons     Lesson[]
  Quizzes     Quiz[]
  Media       CourseMedia[]
}

model Lesson {
  lessonId      Int              @id @default(autoincrement())
  title         String
  banner        String?
  unitId        Int
  courseId      Int
  description   String?
  addedBy       Int
  AddedBy       UserProfile      @relation(fields: [addedBy], references: [userId])
  Unit          Unit             @relation(fields: [unitId], references: [unitId])
  Course        Course           @relation(fields: [courseId], references: [courseId])
  LessonContent LessonContent?
  // timestamp
  createdAt     DateTime         @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime         @updatedAt @db.Timestamptz(3)
  // Relations
  Feedbacks     LessonFeedback[]
  Media         CourseMedia[]
  Quizzes       Quiz[]
}

model LessonContent {
  lessonId    Int         @id
  contentType ContentType
  content     String
  Lesson      Lesson      @relation(fields: [lessonId], references: [lessonId])
  // timestamp
  createdAt   DateTime    @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime    @updatedAt @db.Timestamptz(3)
}

enum ContentType {
  URL
  TEXT
}

model LessonFeedback {
  id       Int         @id @default(autoincrement())
  lessonId Int
  Lesson   Lesson      @relation(fields: [lessonId], references: [lessonId])
  userId   Int
  Profile  UserProfile @relation(fields: [userId], references: [userId])
  feedback String
  Course   Course?     @relation(fields: [courseId], references: [courseId])
  courseId Int?
}

// Quizzes and Asignments

model Quiz {
  quizId             Int              @id @default(autoincrement())
  courseId           Int
  Course             Course           @relation(fields: [courseId], references: [courseId])
  title              String
  unitId             Int?
  Unit               Unit?            @relation(fields: [unitId], references: [unitId])
  lessonId           Int?
  Lesson             Lesson?          @relation(fields: [lessonId], references: [lessonId])
  fullMark           Int              @default(0) @db.SmallInt
  passMark           Int              @default(0) @db.SmallInt
  // Dates
  startsAt           DateTime         @db.Timestamptz(3)
  endsAt             DateTime?        @db.Timestamptz(3)
  lateSubmissionDate DateTime?        @db.Timestamptz(3)
  // timestamp
  createdAt          DateTime         @default(now()) @db.Timestamptz(3)
  updatedAt          DateTime         @updatedAt @db.Timestamptz(3)
  // Relations
  Questions          QuizQuestion[]
  QuizSubmission     QuizSubmission[]
}

model QuizQuestion {
  quizQuestionId Int                  @id @default(autoincrement())
  quizId         Int
  Quiz           Quiz                 @relation(fields: [quizId], references: [quizId])
  questionText   String
  fullMark       Int                  @default(0) @db.SmallInt
  passMark       Int                  @default(0) @db.SmallInt
  correctAnswer  String?
  questionType   QuestionType // Enum for different question types
  // Relations
  Options        QuizQuestionOption[]
  QuizAnswer     QuizAnswer[]
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  LONG_ANSWER
}

// @todo add optional url to a file
model QuizQuestionOption {
  quizeQuestionOptionId Int          @db.SmallInt
  questionId            Int
  Question              QuizQuestion @relation(fields: [questionId], references: [quizQuestionId])
  optionText            String
  mark                  Int          @default(0) @db.SmallInt

  @@id([quizeQuestionOptionId, questionId])
}

model QuizSubmission {
  quizSubmissionId Int          @id @default(autoincrement())
  quizId           Int
  studentId        Int
  marks            Int?
  courseId         Int
  Course           Course       @relation(fields: [courseId], references: [courseId])
  Quiz             Quiz         @relation(fields: [quizId], references: [quizId])
  Student          UserProfile  @relation(fields: [studentId], references: [userId])
  createdAt        DateTime     @default(now()) @db.Timestamptz(3)
  // Relations
  Answers          QuizAnswer[]
}

model QuizAnswer {
  quizAnswerId Int            @id @default(autoincrement())
  submissionId Int
  questionId   Int
  answer       String
  // isCorrect    Boolean?
  mark         Int?           @db.SmallInt
  Submission   QuizSubmission @relation(fields: [submissionId], references: [quizSubmissionId])
  Question     QuizQuestion   @relation(fields: [questionId], references: [quizQuestionId])
}

model CourseProgress {
  courseProgressId Int         @id @default(autoincrement())
  courseId         Int
  course           Course      @relation(fields: [courseId], references: [courseId])
  studentId        Int
  Student          UserProfile @relation(fields: [studentId], references: [userId])
  progress         Float
}

model CourseAttendance {
  courseAttendanceId Int         @id @default(autoincrement())
  courseId           Int
  Course             Course      @relation(fields: [courseId], references: [courseId])
  userId             Int
  Profile            UserProfile @relation(fields: [userId], references: [userId])
  info               String
  date               DateTime    @db.Timestamptz(3)
}

model CourseCertificate {
  courseCertificateId Int         @id @default(autoincrement())
  courseId            Int
  Course              Course      @relation(fields: [courseId], references: [courseId])
  userId              Int
  Profile             UserProfile @relation(fields: [userId], references: [userId])
  issueDate           DateTime    @db.Timestamptz(3)
}

// @todo Forums

// model Forum {
//   id           Int           @id @default(autoincrement())
//   title        String
//   description  String?
//   createdBy    Int
//   Owner        UserProfile   @relation(fields: [createdBy], references: [userId])
//   courseId     Int?
//   Course       Course?       @relation(fields: [courseId], references: [courseId])
//   // timestamp
//   createdAt    DateTime      @default(now()) @db.Timestamptz(3)
//   updatedAt    DateTime      @updatedAt @db.Timestamptz(3)
//   // Relations
//   ForumMembers ForumMember[]
//   ForumPosts   ForumPost[]
// }

// model ForumMember {
//   forumId   Int
//   Forum     Forum          @relation(fields: [forumId], references: [id])
//   memberId  Int
//   Member    UserProfile    @relation(fields: [memberId], references: [userId])
//   position  ForumPositions
//   // timestamp
//   createdAt DateTime       @default(now()) @db.Timestamptz(3)
//   updatedAt DateTime       @updatedAt @db.Timestamptz(3)

//   @@id([forumId, memberId])
// }

// enum ForumPositions {
//   OWNER
//   TEACHER
//   STUDENT
// }

// model ForumPost {
//   id        Int            @id @default(autoincrement())
//   title     String
//   content   String
//   writerId  Int
//   Writer    UserProfile    @relation(fields: [writerId], references: [userId])
//   forumId   Int
//   Forum     Forum          @relation(fields: [forumId], references: [id])
//   // timestamp
//   createdAt DateTime       @default(now()) @db.Timestamptz(3)
//   updatedAt DateTime       @updatedAt @db.Timestamptz(3)
//   // Relations
//   Comments  ForumComment[]
// }

// model ForumComment {
//   id        Int         @id @default(autoincrement())
//   content   String
//   postId    Int
//   post      ForumPost   @relation(fields: [postId], references: [id])
//   writerId  Int
//   Writer    UserProfile @relation(fields: [writerId], references: [userId])
//   // timestamp
//   createdAt DateTime    @default(now()) @db.Timestamptz(3)
//   updatedAt DateTime    @updatedAt @db.Timestamptz(3)
// }

// @todo Chats

// model Chat {
//   id           Int               @id @default(autoincrement())
//   title        String?
//   description  String?
//   bannerUrl    String?
//   createdAt    DateTime          @default(now()) @db.Timestamptz(3)
//   // Relations
//   Participants ChatParticipant[]
//   Messages     Message[]
// }

// // Keep the id field to have the messages nested inside the ChatParticipations for the profile
// model ChatParticipant {
//   id                    Int                   @id @default(autoincrement())
//   profileId             Int
//   Profile               UserProfile           @relation(fields: [profileId], references: [userId])
//   chatId                Int
//   Chat                  Chat                  @relation(fields: [chatId], references: [id])
//   joinedAt              DateTime              @default(now()) @db.Timestamptz(3)
//   participationStatus   ChatParticipantStatus
//   lastReceivedMessageId Int?
//   lastReadMessageId     Int?
//   LastReceivedMessage   Message?              @relation("last_received_message", fields: [lastReceivedMessageId], references: [id])
//   LastReadMessage       Message?              @relation("last_read_message", fields: [lastReadMessageId], references: [id])
//   // Relations
//   SentMessages          Message[]
// }

// enum ChatParticipantStatus {
//   ACTIVE
//   INACTIVE
// }

// model Message {
//   id               Int               @id @default(autoincrement())
//   senderId         Int
//   Sender           ChatParticipant   @relation(fields: [senderId], references: [id])
//   chatId           Int
//   Chat             Chat              @relation(fields: [chatId], references: [id])
//   content          String
//   messageType      MessageType
//   replyToMessageId Int?
//   ReplyToMessage   Message?          @relation("message_reply", fields: [replyToMessageId], references: [id])
//   // timestamp
//   createdAt        DateTime          @default(now()) @db.Timestamptz(3)
//   updatedAt        DateTime          @updatedAt @db.Timestamptz(3)
//   // Relations
//   LastReceivedBy   ChatParticipant[] @relation("last_received_message")
//   LastReadBy       ChatParticipant[] @relation("last_read_message")
//   Replies          Message[]         @relation("message_reply")
// }

// enum MessageType {
//   TEXT
//   FILE
//   IMAGE
//   AUDIO
//   VIDEO
//   // DOCUMENT
// }
